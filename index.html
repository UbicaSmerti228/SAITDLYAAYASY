<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Конструктор артура в4 (Drag & Drop) — текст с переносами</title>
    <style>
        :root {
            --bg-color: #eef2f5;
            --panel-bg: #ffffff;
            --text-color: #333;
            --accent-color: #3498db;
            --danger-color: #e74c3c;
            --border-color: #ddd;
        }

        body {
            margin: 0; padding: 0;
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            overflow: hidden;
            user-select: none;
        }

        .settings-panel {
            width: 400px;
            background: var(--panel-bg);
            border-right: 1px solid var(--border-color);
            padding: 20px;
            overflow-y: auto;
            display: flex; flex-direction: column; gap: 15px;
            box-shadow: 2px 0 15px rgba(0,0,0,0.05);
            z-index: 10;
        }

        h2 { margin: 0; font-size: 1.2rem; display:flex; align-items:center; gap:8px;}
        h3 { font-size: 0.85rem; color: #666; text-transform: uppercase; border-bottom: 2px solid #f0f0f0; padding-bottom: 5px; margin-top: 10px; }

        .control-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 5px; }
        label { display: block; font-size: 0.75rem; margin-bottom: 4px; font-weight: 600; color: #555; }
        input, select, textarea { width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-family: inherit; font-size: 14px; }

        .editor-container {
            background: #eee;
            border: 2px dashed #ccc;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 150px;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }

        #editor-sticker {
            background: white;
            position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            overflow: hidden;
            transition: width 0.3s, height 0.3s, background-color 0.3s;
        }

        .draggable {
            position: absolute;
            cursor: move;
            user-select: none;
            border: 1px dashed transparent;
            padding: 2px;
            box-sizing: border-box;
        }
        .draggable:hover { border-color: var(--accent-color); }
        .draggable:active { border-color: var(--accent-color); opacity: 0.8; }

        /* Изменено: текст теперь допускает перенос строк и имеет ограничение по ширине */
        #drag-text { top: 10px; left: 10px; z-index: 2; display: block; white-space: pre-wrap; word-wrap: break-word; max-width: 100%; }

        #drag-img { top: 30px; left: 30px; z-index: 1; max-width: 80%; max-height: 80%; }
        #drag-img img { display: block; max-width: 100%; pointer-events: none; }

        .btn { border: none; padding: 10px; border-radius: 6px; cursor: pointer; width: 100%; font-weight: bold; font-size: 0.9rem; transition: 0.2s; }
        .btn:hover { opacity: 0.9; }
        .btn-add { background-color: var(--accent-color); color: white; margin-top: 5px; }
        .btn-fill { background-color: #8e44ad; color: white; margin-top: 5px; font-size: 0.8rem; }
        .btn-clear { background-color: white; border:1px solid var(--danger-color); color: var(--danger-color); margin-top: 5px; }
        .btn-print { background-color: #27ae60; color: white; margin-top: auto; padding: 15px; font-size: 1.1rem; }

        .added-list { flex: 1; min-height: 80px; max-height: 200px; overflow-y: auto; border: 1px solid #eee; background: #fafafa; border-radius: 4px; padding: 5px; }
        .added-item { display: flex; justify-content: space-between; padding: 5px; border-bottom: 1px solid #eee; font-size: 0.8rem; align-items: center; }

        .preview-area {
            flex: 1; padding: 40px; background: #525659;
            display: flex; justify-content: center; align-items: flex-start; overflow: auto;
        }

        #sheet {
            width: 210mm; height: 297mm; background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            display: flex; flex-wrap: wrap; align-content: flex-start; justify-content: flex-start;
            position: relative; box-sizing: border-box;
            transform-origin: top center;
        }
        
        #sheet.cut-lines .final-sticker { outline: 1px dashed #ccc; }

        .final-sticker {
            position: relative;
            box-sizing: border-box;
            overflow: hidden;
        }
        .final-sticker div { position: absolute; }

        @media print {
            @page { size: A4; margin: 0; }
            body { background: white; display: block; height: auto; }
            .settings-panel { display: none !important; }
            .preview-area { padding: 0; background: white; display: block; }
            #sheet { box-shadow: none; margin: 0; }
            .final-sticker { outline: 0.5px solid #ddd; }
        }
    </style>
</head>
<body>

    <div class="settings-panel">
        <h2>Конструктор v4.0 — перенос текста</h2>
        
        <div style="background:#fff; border-bottom:1px solid #eee; padding-bottom:10px;">
            <label style="text-align:center; margin-bottom:10px; color:#3498db;">РЕДАКТОР (Двигайте элементы мышкой)</label>
            <div class="editor-container">
                <div id="editor-sticker" style="width:60mm; height:40mm;">
                    <div id="drag-text" class="draggable">Ваш Текст</div>
                    <div id="drag-img" class="draggable" style="display:none;"><img src="" alt=""></div>
                </div>
            </div>
        </div>

        <h3>1. Настройки наклейки</h3>
        <div class="control-group">
            <div><label>Ширина (мм)</label><input type="number" id="inpWidth" value="60" oninput="updateEditor()"></div>
            <div><label>Высота (мм)</label><input type="number" id="inpHeight" value="40" oninput="updateEditor()"></div>
        </div>
        
        <!-- Изменено: textarea вместо input -->
        <div><label>Текст (многострочный)</label>
            <textarea id="inpText" rows="3" oninput="updateEditor()">Ваш Текст</textarea>
        </div>
        
        <div class="control-group">
            <div><label>Размер шрифта</label><input type="number" id="inpFontSize" value="14" oninput="updateEditor()"></div>
            <div><label>Цвет фона</label><input type="color" id="inpBgColor" value="#ffffff" oninput="updateEditor()"></div>
        </div>

        <!-- Опция автоматического переноса и ширина текстового блока -->
        <div class="control-group">
            <div><label>Авто-перенос</label>
                <select id="inpAutoWrap" onchange="updateEditor()">
                    <option value="wrap">Авто (по ширине блока)</option>
                    <option value="nowrap">Нет (одна строка)</option>
                </select>
            </div>
            <div><label>Ширина блока (мм)</label><input type="number" id="inpTextWidth" value="50" oninput="updateEditor()"></div>
        </div>
        
        <div>
            <label>Картинка</label>
            <input type="file" id="inpFile" accept="image/*" onchange="handleImage(this)">
            <button onclick="clearImage()" style="font-size:0.7rem; margin-top:2px; cursor:pointer;">Убрать картинку</button>
        </div>

        <h3>2. Параметры листа</h3>
        <div class="control-group">
            <div><label>Поля листа</label><input type="number" id="pageMargin" value="10" onchange="renderSheet()"></div>
            <div><label>Зазор между</label><input type="number" id="gap" value="2" onchange="renderSheet()"></div>
        </div>
        <div style="margin-top:5px;">
             <input type="checkbox" id="cutLines" onchange="toggleCutLines()" checked> <label for="cutLines" style="display:inline;">Линии реза</label>
        </div>

        <h3>3. Действия</h3>
        <div class="control-group">
            <div><label>Кол-во</label><input type="number" id="inpCount" value="1"></div>
            <button class="btn btn-add" onclick="addToSheet()">Добавить на лист</button>
        </div>
        <button class="btn btn-fill" onclick="fillPage()">Заполнить остаток листа</button>

        <h3>Список</h3>
        <div class="added-list" id="logList"></div>
        <button class="btn btn-clear" onclick="clearAll()">Очистить всё</button>

        <button class="btn btn-print" onclick="window.print()">Печать</button>
    </div>

    <div class="preview-area">
        <div id="sheet" class="cut-lines"></div>
    </div>

    <script>
        // --- ПЕРЕМЕННЫЕ РЕДАКТОРА ---
        const editorSticker = document.getElementById('editor-sticker');
        const dragText = document.getElementById('drag-text');
        const dragImg = document.getElementById('drag-img');
        let currentImgData = null;

        // --- ИНИЦИАЛИЗАЦИЯ DRAG & DROP ---
        dragElement(dragText);
        dragElement(dragImg);

        function dragElement(elmnt) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            elmnt.onmousedown = dragMouseDown;

            function dragMouseDown(e) {
                e = e || window.event;
                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }

            function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
                elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }

        // --- ОБНОВЛЕНИЕ РЕДАКТОРА (REAL-TIME) ---
        function updateEditor() {
            // Размеры наклейки
            const w = document.getElementById('inpWidth').value;
            const h = document.getElementById('inpHeight').value;
            editorSticker.style.width = w + 'mm';
            editorSticker.style.height = h + 'mm';
            editorSticker.style.backgroundColor = document.getElementById('inpBgColor').value;

            // Текст и перенос
            const txt = document.getElementById('inpText').value;
            const fontSize = document.getElementById('inpFontSize').value;
            const autoWrap = document.getElementById('inpAutoWrap').value;
            const textWidth = document.getElementById('inpTextWidth').value;

            if(txt.trim() === "") {
                dragText.style.display = 'none';
            } else {
                dragText.style.display = 'block';
                // сохраняем переносы — заменяем \n на <br>
                dragText.innerHTML = escapeHtml(txt).replace(/\n/g, '<br>');
                dragText.style.fontSize = fontSize + 'px';

                // Ширина текстового блока (внутри редактора) — используем мм
                dragText.style.width = textWidth + 'mm';

                if(autoWrap === 'wrap') {
                    dragText.style.whiteSpace = 'pre-wrap'; // учитывает переводы строки и автоперенос
                    dragText.style.wordBreak = 'break-word';
                } else {
                    dragText.style.whiteSpace = 'nowrap';
                    dragText.style.overflow = 'hidden';
                    dragText.style.textOverflow = 'ellipsis';
                }
            }
        }

        // Простая функция экранирования html для безопасного вывода
        function escapeHtml(unsafe) {
            return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        }

        // --- РАБОТА С КАРТИНКОЙ ---
        function handleImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentImgData = e.target.result;
                    dragImg.querySelector('img').src = currentImgData;
                    dragImg.style.display = 'block';
                    dragImg.style.top = '10px';
                    dragImg.style.left = '10px';
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function clearImage() {
            document.getElementById('inpFile').value = "";
            currentImgData = null;
            dragImg.style.display = 'none';
        }

        // --- ЛОГИКА ЛИСТА (СПИСОК НАКЛЕЕК) ---
        let sheetItems = [];

        function addToSheet(overrideCount = null) {
            const count = overrideCount !== null ? overrideCount : parseInt(document.getElementById('inpCount').value);
            if(count <= 0) return;

            const itemData = {
                w: document.getElementById('inpWidth').value,
                h: document.getElementById('inpHeight').value,
                bg: document.getElementById('inpBgColor').value,
                count: count,
                text: document.getElementById('inpText').value,
                fontSize: document.getElementById('inpFontSize').value,
                textPos: { left: dragText.style.left || '10px', top: dragText.style.top || '10px' },
                imgData: currentImgData,
                imgPos: { left: dragImg.style.left || '10px', top: dragImg.style.top || '10px' },
                // Сохраняем настройки переноса/ширины
                textWidth: document.getElementById('inpTextWidth').value,
                autoWrap: document.getElementById('inpAutoWrap').value
            };

            sheetItems.push(itemData);
            updateList();
            renderSheet();
        }

        function fillPage() {
            const w = parseFloat(document.getElementById('inpWidth').value);
            const h = parseFloat(document.getElementById('inpHeight').value);
            const margin = parseFloat(document.getElementById('pageMargin').value);
            const gap = parseFloat(document.getElementById('gap').value);

            const cols = Math.floor((210 - margin*2 + gap) / (w + gap));
            const rows = Math.floor((297 - margin*2 + gap) / (h + gap));
            const totalCapacity = cols * rows;

            let currentCount = 0;
            sheetItems.forEach(i => currentCount += i.count);
            
            const needed = totalCapacity - currentCount;
            if(needed > 0) addToSheet(needed);
        }

        function clearAll() {
            sheetItems = [];
            updateList();
            renderSheet();
        }

        function removeGroup(idx) {
            sheetItems.splice(idx, 1);
            updateList();
            renderSheet();
        }

        function updateList() {
            const list = document.getElementById('logList');
            list.innerHTML = '';
            sheetItems.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = 'added-item';
                div.innerHTML = `<span>${item.count} шт (${item.w}x${item.h}) — текст ширина ${item.textWidth}мм</span> <span style="cursor:pointer;color:red" onclick="removeGroup(${idx})">✕</span>`;
                list.appendChild(div);
            });
        }

        function renderSheet() {
            const sheet = document.getElementById('sheet');
            sheet.innerHTML = '';
            sheet.style.padding = document.getElementById('pageMargin').value + 'mm';
            sheet.style.gap = document.getElementById('gap').value + 'mm';

            sheetItems.forEach(group => {
                for(let i=0; i<group.count; i++) {
                    const el = document.createElement('div');
                    el.className = 'final-sticker';
                    el.style.width = group.w + 'mm';
                    el.style.height = group.h + 'mm';
                    el.style.backgroundColor = group.bg;

                    // Текст (с учётом переносов и ширины)
                    if(group.text.trim() !== "") {
                        const txt = document.createElement('div');
                        // сохраняем переносы
                        txt.innerHTML = escapeHtml(group.text).replace(/\n/g, '<br>');
                        txt.style.fontSize = group.fontSize + 'px';

                        // Позиция и ширина (используем mm)
                        txt.style.left = group.textPos.left;
                        txt.style.top = group.textPos.top;
                        txt.style.width = group.textWidth + 'mm';
                        
                        if(group.autoWrap === 'wrap') {
                            txt.style.whiteSpace = 'pre-wrap';
                            txt.style.wordBreak = 'break-word';
                        } else {
                            txt.style.whiteSpace = 'nowrap';
                            txt.style.overflow = 'hidden';
                            txt.style.textOverflow = 'ellipsis';
                        }

                        el.appendChild(txt);
                    }

                    // Картинка
                    if(group.imgData) {
                        const imgCont = document.createElement('div');
                        const img = document.createElement('img');
                        img.src = group.imgData;
                        img.style.maxWidth = (parseFloat(group.w)*3) + 'px';
                        
                        imgCont.style.left = group.imgPos.left;
                        imgCont.style.top = group.imgPos.top;
                        imgCont.appendChild(img);
                        el.appendChild(imgCont);
                    }

                    sheet.appendChild(el);
                }
            });
        }

        function toggleCutLines() {
            const sheet = document.getElementById('sheet');
            if(document.getElementById('cutLines').checked) sheet.classList.add('cut-lines');
            else sheet.classList.remove('cut-lines');
        }

        // Стартовые значения
        updateEditor();
    </script>
</body>
</html>
